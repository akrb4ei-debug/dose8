<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Operation Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#070A14;
      --bg2:#101a3a;
      --bg3:#2a0f45;
      --glass: rgba(255,255,255,0.10);
      --stroke: rgba(255,255,255,0.18);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --good: #22ffb4;
      --bad: #ff5e7a;
      --cyan:#00dbde;
      --blue:#4facfe;
      --purple:#8b5cf6;
    }

    *{ box-sizing:border-box; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(79,172,254,0.25), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(139,92,246,0.22), transparent 55%),
        radial-gradient(900px 700px at 45% 95%, rgba(0,219,222,0.18), transparent 55%),
        linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg3), #0a0f22);
      background-size: 400% 400%;
      animation: bgMove 14s ease infinite;
    }
    @keyframes bgMove{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    .wrap{ width:min(1360px, 95vw); margin: 22px auto 44px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px 16px; border-radius: 18px;
      background: var(--glass); border: 1px solid var(--stroke);
      backdrop-filter: blur(16px);
      box-shadow: 0 14px 44px rgba(0,0,0,0.45);
      position: sticky; top: 14px; z-index: 30;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:0.2px; }
    .brand .logo{
      width:34px; height:34px; border-radius: 14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(79,172,254,0.85), rgba(139,92,246,0.75));
      border:1px solid rgba(255,255,255,0.25);
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.85);
      font-weight:800;
      white-space:nowrap;
    }
    .pill.good{ color: var(--good); border-color: rgba(34,255,180,0.22); background: rgba(34,255,180,0.10); }
    .pill.admin{ color: var(--cyan); border-color: rgba(0,219,222,0.22); background: rgba(0,219,222,0.10); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(16px);
      box-shadow: 0 14px 44px rgba(0,0,0,0.40);
    }
    .card h2, .card h3{ margin:0 0 10px; }
    .sub{ color: var(--muted); font-size: 13px; margin-top:-4px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input{
      border:none; outline:none;
      padding: 11px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.18);
      color: var(--text);
      min-width: 190px;
    }
    input::placeholder{ color: rgba(255,255,255,0.55); }

    .btn{
      border:none; outline:none; cursor:pointer; user-select:none;
      padding: 11px 14px;
      border-radius: 14px;
      font-weight:800;
      color: var(--text);
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.18);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,0.35); background: rgba(255,255,255,0.16); }
    .btn:active{ transform: translateY(0px); box-shadow:none; }
    .btn.primary{ background: linear-gradient(135deg, rgba(79,172,254,0.88), rgba(139,92,246,0.72)); border-color: rgba(255,255,255,0.22); }
    .btn.danger{ background: linear-gradient(135deg, rgba(255,75,43,0.84), rgba(255,94,122,0.72)); border-color: rgba(255,255,255,0.22); }
    .btn.admin { background: linear-gradient(135deg, rgba(0,219,222,0.82), rgba(79,172,254,0.70)); color:#06131a; border-color: rgba(255,255,255,0.20); }
    .btn.ghost { background: rgba(255,255,255,0.08); }
    .btn.small{ padding: 7px 10px; border-radius: 12px; font-size: 12px; }
    .btn.icon{ padding: 8px 10px; border-radius: 12px; font-weight: 900; line-height: 1; }

    .kpi{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; margin-top:10px; }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .kpi .box{
      border-radius:16px; padding:12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
    }
    .kpi .label{ font-size:12px; color: var(--muted); font-weight:700; }
    .kpi .value{ font-size:20px; font-weight:900; margin-top:6px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .online-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height: 320px; overflow:auto; padding-right:4px; }
    .chip{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.16);
      font-weight:900;
    }
    .chip .leftPart{ display:flex; align-items:center; gap:10px; }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--good); box-shadow: 0 0 14px rgba(34,255,180,0.45); }
    .dot.off{ background: var(--bad); box-shadow: 0 0 14px rgba(255,94,122,0.45); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 12px; }
    .tab{
      padding: 9px 12px; border-radius: 14px; cursor:pointer;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      font-weight:900; font-size:13px;
      transition: .15s;
      white-space:nowrap;
    }
    .tab.active{
      background: rgba(255,255,255,0.16);
      border:1px solid rgba(255,255,255,0.20);
      box-shadow: 0 10px 24px rgba(0,0,0,0.26);
    }

    .dropdown-wrap{ position:relative; display:inline-flex; }
    .dropdown{
      position:absolute; top: 44px; right:0;
      width: 220px;
      border-radius: 14px;
      background: rgba(15, 18, 30, 0.94);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transform-origin: top right;
      max-height: 0; opacity: 0; transform: translateY(-6px) scale(0.98);
      transition: max-height .22s ease, opacity .22s ease, transform .22s ease;
      pointer-events:none;
      z-index: 40;
    }
    .dropdown.open{ max-height: 320px; opacity: 1; transform: translateY(0px) scale(1); pointer-events:auto; }
    .dropdown button{
      width:100%; text-align:left;
      border:none; outline:none; cursor:pointer;
      padding: 11px 12px;
      background: transparent;
      color: var(--text);
      font-weight:800;
    }
    .dropdown button:hover{ background: rgba(255,255,255,0.08); }

    .tableWrap{ margin-top:10px; overflow:auto; max-height: 520px; }
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      min-width: 860px;
    }
    .table th, .table td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      text-align:center;
      font-size: 13px;
      white-space: nowrap;
      vertical-align: middle;
    }
    .table th{ color: rgba(255,255,255,0.78); font-weight:900; font-size: 12px; letter-spacing:.2px; }
    .table tr:hover td{ background: rgba(255,255,255,0.06); }
    .left{ text-align:left !important; white-space: normal; }

    .eye{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius: 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
      cursor:pointer;
      transition:.15s;
    }
    .eye:hover{ background: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .eye.hidden-eye{ opacity:0.45; position:relative; }
    .eye.hidden-eye::after{
      content:"";
      position:absolute; width:22px; height:2px; background: rgba(255,255,255,0.82);
      transform: rotate(-18deg);
      border-radius:999px;
    }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.62);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal.show{ display:flex; }
    .modal-box{
      width: min(900px, 96vw);
      border-radius: 20px;
      background: rgba(20, 22, 35, 0.92);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
      overflow:hidden;
      animation: pop .18s ease;
    }
    @keyframes pop{
      from{ transform: translateY(8px) scale(0.985); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-bottom:1px solid rgba(255,255,255,0.12);
    }
    .modal-title{ font-weight:900; font-size: 14px; letter-spacing:.2px; }
    .modal-body{ padding: 16px; }
    .modal-foot{
      display:flex; justify-content:flex-end; gap:10px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-top:1px solid rgba(255,255,255,0.12);
      flex-wrap: wrap;
    }

    .picker{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .picker{ grid-template-columns: 1fr; } }
    .panel{
      border-radius: 16px;
      background: rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.14);
      padding: 12px;
    }
    .panel h4{ margin:0 0 10px; font-size: 13px; font-weight:900; }
    .hint{ font-size:12px; color: var(--muted); margin-top:-6px; margin-bottom:8px; font-weight:700; }

    .userlist{ max-height: 360px; overflow:auto; display:flex; flex-direction:column; gap:6px; padding-right:4px; }
    .userrow{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      transition:.12s;
    }
    .userrow:hover{ background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .userrow .name{ font-weight:900; }
    .userrow .tag{
      font-size: 12px; padding: 4px 8px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.16);
      color: rgba(255,255,255,0.85);
      background: rgba(255,255,255,0.06);
      font-weight:900;
      white-space: nowrap;
    }

    .selected{
      display:flex; flex-wrap:wrap; gap:8px;
      min-height: 44px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border:1px dashed rgba(255,255,255,0.20);
    }
    .selchip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(79,172,254,0.14);
      border:1px solid rgba(79,172,254,0.22);
      font-weight:900;
      white-space: nowrap;
    }
    .xbtn{
      width:22px; height:22px; border-radius: 999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.16);
      border:1px solid rgba(255,255,255,0.18);
      cursor:pointer;
      font-weight:900;
    }

    .toggle{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toggle .opt{
      padding: 10px 12px; min-width: 84px; text-align:center;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      cursor:pointer;
      font-weight:900;
      white-space: nowrap;
    }
    .toggle .opt.active{
      background: rgba(34,255,180,0.14);
      border:1px solid rgba(34,255,180,0.28);
      color: var(--good);
      box-shadow: 0 12px 28px rgba(0,0,0,0.22);
    }

    .pager{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 12px; flex-wrap:wrap; }
    .pagebtn{
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
      cursor:pointer;
      font-weight:900;
      white-space: nowrap;
    }
    .pagebtn.active{
      background: rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.22);
    }

    .note{ font-size:12px; color: var(--muted); margin-top:8px; font-weight:700; line-height: 1.5; }
    .tinyStatus{ margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.70); font-weight: 800; min-height: 16px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ®</div>
        <div>
          <div style="font-size:16px; font-weight:900;">Operation Dashboard</div>
          <div style="font-size:12px; color:var(--muted); font-weight:700;">ê·¼íƒœ + ì½˜í…ì¸ (ë³´ê¸‰/ì†¡ì „ì†Œ) ìš´ì˜íˆ´</div>
        </div>
      </div>
      <div class="row">
        <span class="pill good" id="realtimePill">ì‹¤ì‹œê°„: ON</span>
        <span class="pill" id="whoami">ë¯¸ë¡œê·¸ì¸</span>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <h2>ë©”ì¸</h2>
        <div class="sub">ì¶œê·¼/í‡´ê·¼ + ë³´ê¸‰/ì†¡ì „ì†Œ ì§„í–‰ì€ ì—¬ê¸°ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>

        <div class="row" style="margin-top:12px;">
          <input id="nickname" placeholder="ë‹‰ë„¤ì„(ì•„ì´ë””)" autocomplete="username" />
          <input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" autocomplete="current-password" />
          <button class="btn primary" id="loginBtn">ë¡œê·¸ì¸</button>
          <button class="btn ghost" id="logoutBtn" disabled>ë¡œê·¸ì•„ì›ƒ</button>
          <button class="btn admin" id="adminBtn" style="display:none;">ê´€ë¦¬</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="label">í˜„ì¬ ì ‘ì†</div>
            <div class="value good" id="kpiOnline">0</div>
          </div>
          <div class="box">
            <div class="label">ë‚´ ìƒíƒœ</div>
            <div class="value" id="kpiMe">-</div>
          </div>
          <div class="box">
            <div class="label">ì˜¤ëŠ˜ ì½˜í…ì¸ </div>
            <div class="value" id="kpiTodayContent">-</div>
          </div>
          <div class="box">
            <div class="label">ìµœê·¼ 7ì¼ ë‚´ ê·¼ë¬´</div>
            <div class="value" id="kpiWeekHours">-</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="checkInBtn" disabled>ì¶œê·¼</button>
          <button class="btn danger" id="checkOutBtn" disabled>í‡´ê·¼</button>
          <button class="btn" id="supplyBtn" disabled>ë³´ê¸‰</button>
          <button class="btn" id="powerBtn" disabled>ì†¡ì „ì†Œ</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">ì ‘ì†ì¤‘(ì¶œê·¼ì¤‘) ëª©ë¡</h3>
            <span class="pill good">ì‹¤ì‹œê°„</span>
          </div>
          <div class="sub">ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ì—¬ê¸°ì„œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ê´€ë¦¬ìëŠ” ë³´ì…ë‹ˆë‹¤.)</div>
          <div class="online-list" id="onlineUsers"></div>
          <!-- âœ… ìš”ì²­ì‚¬í•­: ì ‘ì† ëª©ë¡ì— ìˆë˜ ì£¼ì„(ë…¸íŠ¸)ì„ ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤. -->
        </div>
      </div>

      <!-- Admin -->
      <div class="card" id="adminPanel" style="display:none; min-height: 820px;">
        <h2>ê´€ë¦¬</h2>
        <div class="sub">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ / í†µê³„ / ì½˜í…ì¸  ê¸°ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>

        <div class="tabs">
          <div class="tab active" data-tab="users">ìœ ì €/í†µê³„</div>
          <div class="tab" data-tab="content">ì½˜í…ì¸  ê¸°ë¡</div>
        </div>

        <!-- Users/Stats -->
        <div id="tabUsers">
          <div class="row">
            <button class="btn admin" id="refreshStatsBtn">í†µê³„ ê°±ì‹ </button>
            <button class="btn" id="adminRoleBtn">ê´€ë¦¬ì ê¶Œí•œ</button>
            <button class="btn danger" id="resetWorkBtn">ì´ ì¶œê·¼ì‹œê°„ ì´ˆê¸°í™”</button>
          </div>
          <div class="tinyStatus" id="statsMsg"></div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ë“±ë¡ ìœ ì €)</h3>
            <div class="row">
              <input id="newUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="newPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="addUserBtn">ìœ ì € ì¶”ê°€</button>
            </div>

            <div class="row">
              <input id="editUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="editPass" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="changePassBtn">ë¹„ë²ˆ ë³€ê²½</button>
              <button class="btn danger" id="deleteUserBtn">ìœ ì € ì‚­ì œ</button>
            </div>

            <div class="note">â€¢ ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì€ ë™ì¼í•˜ê²Œ íŒì •ë˜ë©°, ë‚´ë¶€ ë¹„êµëŠ” ì†Œë¬¸ìë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.</div>

            <div class="tableWrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ì ‘ì†</th>
                    <th>ë§ˆì§€ë§‰ ì¶œê·¼</th>
                    <th>ë§ˆì§€ë§‰ í‡´ê·¼</th>
                    <th>ìµœê·¼ 7ì¼ ê·¼ë¬´ì‹œê°„</th>
                    <th>ì†¡ì „ì†Œ íšŸìˆ˜</th>
                    <th>ë³´ê¸‰ íšŸìˆ˜</th>
                    <th>ìˆ¨ê¹€</th>
                  </tr>
                </thead>
                <tbody id="userStatsBody">
                  <tr><td colspan="8" style="color:rgba(255,255,255,0.65);">í†µê³„ ê°±ì‹ ì„ ëˆŒëŸ¬ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Content records -->
        <div id="tabContent" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="dropdown-wrap">
              <button class="btn" id="filterBtn">í•„í„° â–¾</button>
              <div class="dropdown" id="filterMenu">
                <button data-filter="all">ì „ì²´ ë³´ê¸°</button>
                <button data-filter="supply">ë³´ê¸‰ë§Œ ë³´ê¸°</button>
                <button data-filter="power">ì†¡ì „ì†Œë§Œ ë³´ê¸°</button>
              </div>
            </div>

            <div class="row">
              <!-- âœ… ì†Œí”„íŠ¸ ì‚­ì œ í‘œì‹œ í† ê¸€ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤. -->
              <button class="btn ghost" id="toggleDeletedBtn" title="ì‚­ì œëœ ê¸°ë¡ í‘œì‹œ í† ê¸€ì…ë‹ˆë‹¤.">ì‚­ì œëœ ê¸°ë¡ ë³´ê¸°: OFF</button>
              <span class="pill good">1í˜ì´ì§€ ì‹¤ì‹œê°„</span>
              <button class="btn admin" id="refreshContentBtn">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>

          <div class="note">
            â€¢ 20ê°œì”© í˜ì´ì§€ë¡œ êµ¬ì„±ë˜ë©°, 1í˜ì´ì§€ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.<br>
            â€¢ ì¼ë°˜ ìœ ì €ëŠ” â€œìˆ¨ê¹€ ìœ ì €â€ê°€ ì°¸ì—¬ì í‘œì‹œì—ì„œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” ëª¨ë‘ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            â€¢ ì‚­ì œëŠ” ì†Œí”„íŠ¸ ì‚­ì œë¡œ ì²˜ë¦¬ë˜ë©°, í•„ìš” ì‹œ â€œì‚­ì œëœ ê¸°ë¡ ë³´ê¸°â€ë¡œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>

          <div class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>íƒ€ì…</th>
                  <th>ë‚ ì§œ/ì‹œê°„</th>
                  <th>ì°¸ì—¬ì ëª©ë¡</th>
                  <th>ë³´ê¸‰ íšë“</th>
                  <th>ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="contentBody"></tbody>
            </table>
          </div>

          <div class="pager" id="pager"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div class="modal" id="alertModal" aria-hidden="true">
    <div class="modal-box" style="width:min(520px,96vw);">
      <div class="modal-head">
        <div class="modal-title">ì•Œë¦¼</div>
        <button class="btn small ghost" id="alertClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="alertText" style="font-weight:900; font-size:14px;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" id="alertOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Content Modal -->
  <div class="modal" id="contentModal" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title" id="contentTitle">ì½˜í…ì¸ </div>
        <button class="btn small ghost" id="contentCloseTop">ë‹«ê¸°</button>
      </div>

      <div class="modal-body">
        <div class="picker">
          <div class="panel">
            <h4>ëª…ë‹¨ ì¶”ê°€</h4>
            <div class="hint">ëª©ë¡ì—ì„œ í´ë¦­í•˜ë©´ ì°¸ì—¬ìì— ì¶”ê°€ë©ë‹ˆë‹¤.</div>
            <div class="row">
              <input id="userSearch" placeholder="ê²€ìƒ‰(ë‹‰ë„¤ì„)" style="flex:1 1 auto; min-width: 220px;">
              <button class="btn small" id="toggleUserListBtn">+ ëª…ë‹¨ í¼ì¹˜ê¸°</button>
            </div>
            <div id="userListWrap" style="margin-top:10px; display:none;">
              <div class="userlist" id="userList"></div>
            </div>
          </div>

          <div class="panel">
            <h4>ì°¸ì—¬ì</h4>
            <div class="hint">âŒë¡œ ì œê±° ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
            <div class="selected" id="selectedUsers"></div>

            <div style="height:12px;"></div>

            <div id="supplyResultWrap" style="display:none;">
              <h4>ë³´ê¸‰í’ˆ íšë“ ì—¬ë¶€</h4>
              <div class="hint">O / X ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</div>
              <div class="toggle">
                <div class="opt" id="optO">O</div>
                <div class="opt" id="optX">X</div>
              </div>
            </div>

            <div class="note" id="contentHint"></div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" id="contentCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="contentSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Admin Role Modal -->
  <div class="modal" id="adminRoleModal" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title">ê´€ë¦¬ì ê¶Œí•œ</div>
        <button class="btn small ghost" id="adminRoleCloseTop">ë‹«ê¸°</button>
      </div>

      <div class="modal-body">
        <div class="picker">
          <div class="panel">
            <h4>ìœ ì € ì„ íƒ</h4>
            <div class="hint">ì—¬ëŸ¬ ëª… ì„ íƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
            <div class="row">
              <input id="adminRoleSearch" placeholder="ê²€ìƒ‰(ë‹‰ë„¤ì„)" style="flex:1 1 auto; min-width: 220px;">
              <button class="btn small" id="adminRoleToggleListBtn">+ ëª©ë¡ í¼ì¹˜ê¸°</button>
            </div>
            <div id="adminRoleListWrap" style="margin-top:10px; display:none;">
              <div class="userlist" id="adminRoleList"></div>
            </div>
          </div>

          <div class="panel">
            <h4>ì„ íƒëœ ìœ ì €</h4>
            <div class="hint">ì„ëª…/í•´ì„ì„ ëˆ„ë¥´ë©´ ì¼ê´„ ì ìš©ë©ë‹ˆë‹¤.</div>
            <div class="selected" id="adminRoleSelected"></div>
            <div class="note">â€¢ ê´€ë¦¬ì í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ ìœ ì €ë„ í•­ìƒ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn danger" id="adminRoleRevokeBtn">ì„ íƒ í•´ì„</button>
        <button class="btn admin" id="adminRoleGrantBtn">ì„ íƒ ì„ëª…</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection, doc, getDoc, setDoc, updateDoc, deleteDoc, addDoc,
    getDocs, query, where, orderBy, limit, startAfter,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Firebase ì„¤ì •ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
  const firebaseConfig = {
    apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
    authDomain: "dosep-b6ee3.firebaseapp.com",
    projectId: "dosep-b6ee3",
    storageBucket: "dosep-b6ee3.firebasestorage.app",
    messagingSenderId: "100096560571",
    appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM ì ‘ê·¼ì„ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤.
  const $ = (id) => document.getElementById(id);

  // ë‹‰ë„¤ì„ì€ ì†Œë¬¸ìë¡œ í†µì¼í•˜ì—¬ ë¹„êµí•©ë‹ˆë‹¤.
  const lowerNick = (s) => (s || "").trim().toLowerCase();

  // í˜„ì¬ ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ì–»ìŠµë‹ˆë‹¤.
  const nowMs = () => Date.now();

  // ì‹œê°„ í‘œì‹œ ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.
  const fmt = (ms) => {
    if (!ms) return "-";
    try { return new Date(ms).toLocaleString(); } catch { return "-"; }
  };

  // ì•Œë¦¼ ëª¨ë‹¬ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
  const alertModal = $("alertModal");
  const alertText = $("alertText");
  function showAlert(msg){
    alertText.textContent = msg;
    alertModal.classList.add("show");
    alertModal.setAttribute("aria-hidden","false");
  }
  function closeAlert(){
    alertModal.classList.remove("show");
    alertModal.setAttribute("aria-hidden","true");
  }
  $("alertOk").addEventListener("click", closeAlert);
  $("alertClose").addEventListener("click", closeAlert);
  alertModal.addEventListener("click", (e)=>{ if(e.target===alertModal) closeAlert(); });

  // í†µê³„ ê°±ì‹  ë©”ì‹œì§€ë¥¼ ì¡°ìš©íˆ í‘œì‹œí•©ë‹ˆë‹¤.
  function setTinyStatus(id, msg){
    const el = $(id);
    el.textContent = msg || "";
    if(!msg) return;
    setTimeout(()=>{ if(el.textContent === msg) el.textContent = ""; }, 4000);
  }

  // ì „ì—­ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
  let currentUser = null;
  let currentIsAdmin = false;

  // ìœ ì € ìºì‹œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
  let usersCache = new Map();
  let usersUnsub = null;

  // ì¶œê·¼ì¤‘ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
  let onlineUnsub = null;

  // ì½˜í…ì¸  ëª¨ë‹¬ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
  let contentType = null;
  let selectedSet = new Set();
  let supplyResult = null;

  // ê´€ë¦¬ì ê¶Œí•œ ëª¨ë‹¬ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
  let adminRoleSet = new Set();

  // ì½˜í…ì¸  ëª©ë¡ í˜ì´ì§• ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
  const PAGE_SIZE = 20;
  let contentFilter = "all";
  let contentPage = 1;
  let contentFirstUnsub = null;
  const pageCursors = [];

  // âœ… ì†Œí”„íŠ¸ ì‚­ì œëœ ê¸°ë¡ í‘œì‹œ í† ê¸€ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
  let showDeletedContent = false;

  // Firestore ì»¬ë ‰ì…˜ì„ ì •ì˜í•©ë‹ˆë‹¤.
  const colUsers = collection(db, "users");
  const colWork = collection(db, "workRecords");
  const colContent = collection(db, "contentRecords");

  // ìƒë‹¨ ì‚¬ìš©ì í‘œì‹œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
  function setWhoami(){
    $("whoami").textContent = currentUser
      ? `ì ‘ì†: ${currentUser}${currentIsAdmin ? " (ê´€ë¦¬ì)" : ""}`
      : "ë¯¸ë¡œê·¸ì¸";
  }

  // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœë¥¼ ì œì–´í•©ë‹ˆë‹¤.
  function setLoggedInUI(on){
    $("logoutBtn").disabled = !on;
    $("checkInBtn").disabled = !on;
    $("checkOutBtn").disabled = !on;
    $("supplyBtn").disabled = !on;
    $("powerBtn").disabled = !on;
    if(!on){
      $("adminBtn").style.display = "none";
      $("adminPanel").style.display = "none";
    }
  }

  // ê´€ë¦¬ì ê¶Œí•œì— ë”°ë¼ ê´€ë¦¬ì ë²„íŠ¼ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
  function setAdminUI(on){
    $("adminBtn").style.display = on ? "inline-flex" : "none";
  }

  // ìœ ì € ìºì‹œë¥¼ 1íšŒ ë¡œë“œí•©ë‹ˆë‹¤.
  async function refreshUsersCacheOnce(){
    const snap = await getDocs(colUsers);
    const map = new Map();
    snap.forEach(d => map.set(d.id, d.data() || {}));
    usersCache = map;
  }

  // ìœ ì € ìºì‹œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
  function startUsersRealtime(){
    stopUsersRealtime();
    usersUnsub = onSnapshot(colUsers, (snap)=>{
      const map = new Map();
      snap.forEach(d => map.set(d.id, d.data() || {}));
      usersCache = map;
    });
  }

  // ìœ ì € ìºì‹œ ì‹¤ì‹œê°„ êµ¬ë…ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
  function stopUsersRealtime(){
    if(usersUnsub){ usersUnsub(); usersUnsub = null; }
  }

  // ì´ˆê¸° UIë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  setLoggedInUI(false);
  setWhoami();

  // ë¡œê·¸ì¸ ë²„íŠ¼ ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("loginBtn").addEventListener("click", async ()=>{
    const nick = lowerNick($("nickname").value);
    const pass = $("password").value;

    if(!nick || !pass) return showAlert("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const uSnap = await getDoc(doc(db,"users",nick));
      if(!uSnap.exists()) return showAlert("í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤.");

      const u = uSnap.data() || {};
      if((u.password ?? "") !== pass) return showAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      currentUser = nick;
      currentIsAdmin = !!u.isAdmin;

      setWhoami();
      setLoggedInUI(true);
      setAdminUI(currentIsAdmin);

      startUsersRealtime();
      await refreshUsersCacheOnce();

      startOnlineRealtime();
      await refreshKPI();

      showAlert("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      showAlert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. (Rules/DBë¥¼ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.)");
    }
  });

  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("logoutBtn").addEventListener("click", ()=>{
    stopContentRealtime();
    stopOnlineRealtime();
    stopUsersRealtime();

    currentUser = null;
    currentIsAdmin = false;

    $("adminPanel").style.display = "none";
    setWhoami();
    setLoggedInUI(false);

    $("kpiOnline").textContent = "0";
    $("kpiMe").textContent = "-";
    $("kpiTodayContent").textContent = "-";
    $("kpiWeekHours").textContent = "-";
    $("onlineUsers").innerHTML = "";

    showAlert("ë¡œê·¸ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  });

  // ì¶œê·¼ ë²„íŠ¼ ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("checkInBtn").addEventListener("click", async ()=>{
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const q = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const snap = await getDocs(q);
      if(!snap.empty) return showAlert("í‡´ê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

      await addDoc(colWork, { nickname: currentUser, checkIn: nowMs(), checkOut: null });
      showAlert("ì¶œê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch(e){
      showAlert("ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // í‡´ê·¼ ë²„íŠ¼ ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("checkOutBtn").addEventListener("click", async ()=>{
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const q = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const snap = await getDocs(q);
      if(snap.empty) return showAlert("ì¶œê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

      await updateDoc(snap.docs[0].ref, { checkOut: nowMs() });
      showAlert("í‡´ê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch(e){
      showAlert("í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ì¶œê·¼ì¤‘ ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë…ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
  function stopOnlineRealtime(){
    if(onlineUnsub){ onlineUnsub(); onlineUnsub = null; }
  }

  // ì¶œê·¼ì¤‘ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ í•©ë‹ˆë‹¤.
  function startOnlineRealtime(){
    stopOnlineRealtime();

    const q = query(colWork, where("checkOut","==", null));
    onlineUnsub = onSnapshot(q, (snap)=>{
      const online = new Set();

      snap.forEach(d=>{
        const r = d.data() || {};
        const n = lowerNick(r.nickname);
        if(!n) return;

        const u = usersCache.get(n);
        if(!currentIsAdmin && u?.hidden) return;

        online.add(n);
      });

      const list = Array.from(online).sort((a,b)=>a.localeCompare(b));
      $("kpiOnline").textContent = String(list.length);

      if(list.length === 0){
        $("onlineUsers").innerHTML = `<div class="chip"><div class="leftPart"><span class="dot off"></span><span>ì ‘ì† X</span></div><span class="bad">ì ‘ì† X</span></div>`;
      }else{
        $("onlineUsers").innerHTML = list.map(n => {
          const u = usersCache.get(n) || {};
          const hiddenBadge = (currentIsAdmin && u.hidden) ? `<span class="pill" style="opacity:.8;">ìˆ¨ê¹€</span>` : ``;
          return `
            <div class="chip">
              <div class="leftPart"><span class="dot"></span><span>${n}</span>${hiddenBadge}</div>
              <span class="good">ì ‘ì† O</span>
            </div>
          `;
        }).join("");
      }
    });
  }

  // KPIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
  async function refreshKPI(){
    if(!currentUser){
      $("kpiMe").textContent = "-";
      $("kpiWeekHours").textContent = "-";
      $("kpiTodayContent").textContent = "-";
      return;
    }

    try{
      const q = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const s = await getDocs(q);
      const online = !s.empty;
      $("kpiMe").innerHTML = online
        ? `<span class="good">ğŸŸ¢ ì ‘ì† O</span>`
        : `<span class="bad">ğŸ”´ ì ‘ì† X</span>`;
    }catch{
      $("kpiMe").textContent = "-";
    }

    try{
      const weekAgo = nowMs() - 7*24*60*60*1000;
      const snap = await getDocs(query(colWork, where("nickname","==", currentUser)));
      let totalMs = 0;

      snap.forEach(d=>{
        const r = d.data() || {};
        const ci = r.checkIn;
        const co = (r.checkOut == null) ? nowMs() : r.checkOut;
        if(typeof ci !== "number") return;

        const start = Math.max(ci, weekAgo);
        const end = co;
        if(end <= weekAgo) return;
        if(end > start) totalMs += (end - start);
      });

      $("kpiWeekHours").textContent = `${(totalMs/3600000).toFixed(2)}h`;
    }catch{
      $("kpiWeekHours").textContent = "-";
    }

    try{
      const today = new Date(); today.setHours(0,0,0,0);
      const startMs = today.getTime();
      const csnap = await getDocs(colContent);
      let cnt = 0;
      csnap.forEach(d=>{
        const c = d.data() || {};
        const deleted = !!c.deleted;
        if(deleted) return;
        if((c.time || 0) >= startMs) cnt++;
      });
      $("kpiTodayContent").textContent = `${cnt}ê±´`;
    }catch{
      $("kpiTodayContent").textContent = "-";
    }
  }

  // ì½˜í…ì¸  ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
  const contentModal = $("contentModal");
  function openContentModal(type){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    contentType = type;
    selectedSet = new Set();
    supplyResult = null;

    $("contentTitle").textContent = (type === "supply") ? "ğŸ“¦ ë³´ê¸‰ ë“±ë¡" : "âš¡ ì†¡ì „ì†Œ ë“±ë¡";
    $("contentHint").textContent = (type === "supply")
      ? "ë³´ê¸‰ì€ O/X(íšë“ ì—¬ë¶€)ê°€ í•„ìš”í•©ë‹ˆë‹¤."
      : "ì†¡ì „ì†ŒëŠ” ì°¸ì—¬ìë§Œ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤.";

    $("supplyResultWrap").style.display = (type === "supply") ? "block" : "none";
    $("optO").classList.remove("active");
    $("optX").classList.remove("active");

    $("userSearch").value = "";
    $("userListWrap").style.display = "none";

    renderSelected();
    renderUserList();

    contentModal.classList.add("show");
    contentModal.setAttribute("aria-hidden","false");
  }

  // ì½˜í…ì¸  ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
  function closeContentModal(){
    contentModal.classList.remove("show");
    contentModal.setAttribute("aria-hidden","true");
  }

  $("contentCloseTop").addEventListener("click", closeContentModal);
  $("contentCancel").addEventListener("click", closeContentModal);
  contentModal.addEventListener("click", (e)=>{ if(e.target===contentModal) closeContentModal(); });

  $("supplyBtn").addEventListener("click", ()=> openContentModal("supply"));
  $("powerBtn").addEventListener("click", ()=> openContentModal("power"));

  $("toggleUserListBtn").addEventListener("click", ()=>{
    const wrap = $("userListWrap");
    wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
  });
  $("userSearch").addEventListener("input", renderUserList);

  $("optO").addEventListener("click", ()=>{
    supplyResult = "O";
    $("optO").classList.add("active");
    $("optX").classList.remove("active");
  });
  $("optX").addEventListener("click", ()=>{
    supplyResult = "X";
    $("optX").classList.add("active");
    $("optO").classList.remove("active");
  });

  // ì„ íƒëœ ì°¸ì—¬ì ì¹©ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderSelected(){
    const el = $("selectedUsers");
    if(selectedSet.size === 0){
      el.innerHTML = `<span style="color:rgba(255,255,255,0.65); font-weight:900;">ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
      return;
    }
    el.innerHTML = Array.from(selectedSet).map(n => `
      <span class="selchip">
        ${n}
        <span class="xbtn" data-x="${n}">Ã—</span>
      </span>
    `).join("");

    el.querySelectorAll(".xbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        selectedSet.delete(btn.getAttribute("data-x"));
        renderSelected();
      });
    });
  }

  // ìœ ì € ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderUserList(){
    const list = $("userList");
    const q = lowerNick($("userSearch").value);

    const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));
    let filtered = q ? users.filter(n => n.includes(q)) : users;

    if(!currentIsAdmin){
      filtered = filtered.filter(n => !(usersCache.get(n)?.hidden));
    }

    list.innerHTML = filtered.length ? filtered.map(n=>{
      const u = usersCache.get(n) || {};
      const badges = [];
      if(u.isAdmin) badges.push("ê´€ë¦¬ì");
      if(u.hidden) badges.push("ìˆ¨ê¹€");
      const tag = badges.length ? badges.join(" Â· ") : "ìœ ì €";
      return `
        <div class="userrow" data-nick="${n}">
          <div class="name">${n}</div>
          <div class="tag">${tag}</div>
        </div>
      `;
    }).join("") : `<div style="color:rgba(255,255,255,0.7); font-weight:900;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

    list.querySelectorAll(".userrow").forEach(row=>{
      row.addEventListener("click", ()=>{
        const n = row.getAttribute("data-nick");
        if(!n) return;
        selectedSet.add(n);
        renderSelected();
      });
    });
  }

  // ì½˜í…ì¸  ì €ì¥ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("contentSave").addEventListener("click", async ()=>{
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    const participants = Array.from(selectedSet);

    if(participants.length === 0) return showAlert("ì°¸ì—¬ìë¥¼ 1ëª… ì´ìƒ ì¶”ê°€í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    const payload = {
      type: contentType,
      time: nowMs(),
      participants,
      deleted: false,
      deletedAt: null,
      deletedBy: null
    };

    if(contentType === "supply"){
      if(!supplyResult) return showAlert("ë³´ê¸‰ íšë“ ì—¬ë¶€(O/X)ë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
      payload.result = supplyResult;
    }

    try{
      await addDoc(colContent, payload);
      closeContentModal();
      showAlert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch(e){
      showAlert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ê´€ë¦¬ì íƒ­ ì „í™˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  const tabs = Array.from(document.querySelectorAll(".tab"));
  function openTab(key){
    tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === key));
    $("tabUsers").style.display = (key === "users") ? "block" : "none";
    $("tabContent").style.display = (key === "content") ? "block" : "none";

    if(key === "content"){
      contentPage = 1;
      renderPager(1);
      openContentPage(1);
    }else{
      stopContentRealtime();
    }
  }
  tabs.forEach(t => t.addEventListener("click", ()=> openTab(t.getAttribute("data-tab"))));

  // ê´€ë¦¬ì íŒ¨ë„ ë²„íŠ¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("adminBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    $("adminPanel").style.display = "block";
    openTab("users");
    await refreshUsersCacheOnce();
  });

  // ìœ ì € ì¶”ê°€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("addUserBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    const n = lowerNick($("newUser").value);
    const p = $("newPass").value;

    if(!n) return showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    if(!p) return showAlert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      await setDoc(doc(db,"users",n), { password: p, isAdmin:false, hidden:false }, { merge:true });
      showAlert("ìœ ì € ì¶”ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      $("newUser").value=""; $("newPass").value="";
    }catch(e){
      showAlert("ìœ ì € ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("changePassBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const n = lowerNick($("editUser").value);
    const p = $("editPass").value;
    if(!n || !p) return showAlert("ë‹‰ë„¤ì„ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      await updateDoc(doc(db,"users",n), { password: p });
      $("editPass").value="";
      showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ìœ ì € ì‚­ì œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("deleteUserBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const n = lowerNick($("editUser").value);
    if(!n) return showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    if(n === currentUser) return showAlert("ë³¸ì¸ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    try{
      await deleteDoc(doc(db,"users",n));
      showAlert("ìœ ì € ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      showAlert("ìœ ì € ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ê·¼íƒœ ê¸°ë¡ ì „ì²´ ì‚­ì œë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("resetWorkBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    try{
      const snap = await getDocs(colWork);
      const ops = [];
      snap.forEach(d => ops.push(deleteDoc(d.ref)));
      await Promise.all(ops);
      showAlert("ê·¼íƒœ ê¸°ë¡ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch(e){
      showAlert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // í†µê³„ ê°±ì‹ ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  $("refreshStatsBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    try{
      const workSnap = await getDocs(colWork);
      const workByUser = new Map();
      workSnap.forEach(d=>{
        const r = d.data() || {};
        const n = lowerNick(r.nickname);
        if(!n) return;
        if(!workByUser.has(n)) workByUser.set(n, []);
        workByUser.get(n).push(r);
      });

      const contentSnap = await getDocs(colContent);
      const supplyCount = new Map();
      const powerCount = new Map();
      contentSnap.forEach(d=>{
        const c = d.data() || {};
        if(!!c.deleted) return;
        const type = c.type;
        const participants = Array.isArray(c.participants) ? c.participants.map(lowerNick) : [];
        for(const p of participants){
          if(!p) continue;
          if(type === "supply") supplyCount.set(p, (supplyCount.get(p)||0) + 1);
          if(type === "power") powerCount.set(p, (powerCount.get(p)||0) + 1);
        }
      });

      const weekAgo = nowMs() - 7*24*60*60*1000;
      const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));

      const rows = users.map(n=>{
        const u = usersCache.get(n) || {};

        const records = workByUser.get(n) || [];
        const online = records.some(r => r.checkOut == null);

        let lastIn = 0, lastOut = 0;
        for(const r of records){
          if(typeof r.checkIn === "number") lastIn = Math.max(lastIn, r.checkIn);
          if(typeof r.checkOut === "number") lastOut = Math.max(lastOut, r.checkOut);
        }

        let totalMs = 0;
        for(const r of records){
          const ci = r.checkIn;
          const co = (r.checkOut == null) ? nowMs() : r.checkOut;
          if(typeof ci !== "number") continue;
          const start = Math.max(ci, weekAgo);
          const end = co;
          if(end <= weekAgo) continue;
          if(end > start) totalMs += (end - start);
        }

        const statusHtml = online
          ? `<span class="good">ğŸŸ¢ ì ‘ì† O</span>`
          : `<span class="bad">ğŸ”´ ì ‘ì† X</span>`;

        const pCnt = powerCount.get(n) || 0;
        const sCnt = supplyCount.get(n) || 0;

        const hiddenBadge = u.hidden ? ` <span class="pill" style="opacity:.85;">ìˆ¨ê¹€</span>` : ``;
        const adminBadge = u.isAdmin ? ` <span class="pill admin" style="margin-left:6px;">ADMIN</span>` : ``;

        return `
          <tr>
            <td style="font-weight:900;" class="left">${n}${adminBadge}${hiddenBadge}</td>
            <td>${statusHtml}</td>
            <td>${fmt(lastIn)}</td>
            <td>${fmt(lastOut)}</td>
            <td>${(totalMs/3600000).toFixed(2)}h</td>
            <td>${pCnt}</td>
            <td>${sCnt}</td>
            <td>
              <span class="eye ${u.hidden ? "hidden-eye" : ""}" data-eye="${n}" title="ìˆ¨ê¹€ í† ê¸€">ğŸ‘</span>
            </td>
          </tr>
        `;
      }).join("");

      $("userStatsBody").innerHTML = rows || `<tr><td colspan="8" style="color:rgba(255,255,255,0.65);">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

      document.querySelectorAll("[data-eye]").forEach(el=>{
        el.addEventListener("click", async ()=>{
          const nick = el.getAttribute("data-eye");
          const cur = usersCache.get(nick) || {};
          try{
            await updateDoc(doc(db,"users",nick), { hidden: !cur.hidden });
            setTinyStatus("statsMsg", "ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
            $("refreshStatsBtn").click();
          }catch(e){
            showAlert("ìˆ¨ê¹€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
        });
      });

      setTinyStatus("statsMsg", "ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      showAlert("í†µê³„ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // í•„í„° ë“œë¡­ë‹¤ìš´ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  const filterBtn = $("filterBtn");
  const filterMenu = $("filterMenu");
  const closeFilter = ()=> filterMenu.classList.remove("open");

  filterBtn.addEventListener("click", ()=> filterMenu.classList.toggle("open"));
  document.addEventListener("click", (e)=>{
    if(!filterMenu.contains(e.target) && e.target !== filterBtn) closeFilter();
  });
  filterMenu.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      contentFilter = b.getAttribute("data-filter");
      closeFilter();
      contentPage = 1;
      renderPager(1);
      openContentPage(1);
    });
  });

  // âœ… ì‚­ì œëœ ê¸°ë¡ í‘œì‹œ í† ê¸€ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  const toggleDeletedBtn = $("toggleDeletedBtn");
  toggleDeletedBtn.addEventListener("click", ()=>{
    showDeletedContent = !showDeletedContent;
    toggleDeletedBtn.textContent = `ì‚­ì œëœ ê¸°ë¡ ë³´ê¸°: ${showDeletedContent ? "ON" : "OFF"}`;
    contentPage = 1;
    renderPager(1);
    openContentPage(1);
  });

  $("refreshContentBtn").addEventListener("click", ()=>{
    contentPage = 1;
    renderPager(1);
    openContentPage(1);
  });

  // ì½˜í…ì¸  ì‹¤ì‹œê°„ êµ¬ë…ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
  function stopContentRealtime(){
    if(contentFirstUnsub){
      contentFirstUnsub();
      contentFirstUnsub = null;
    }
  }

  // ìˆ¨ê¹€ ìœ ì € í•„í„°ë¥¼ ì°¸ì—¬ì ëª©ë¡ì— ì ìš©í•©ë‹ˆë‹¤.
  function applyHiddenFilterToParticipants(parts){
    if(currentIsAdmin) return parts;
    return parts.filter(n => !(usersCache.get(lowerNick(n))?.hidden));
  }

  // ì½˜í…ì¸  í–‰ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderContentRows(docs){
    const rows = docs.map(ds=>{
      const c = ds.data() || {};
      const type = c.type || "-";

      const deleted = !!c.deleted;
      if(!showDeletedContent && deleted) return null;

      if(contentFilter !== "all" && type !== contentFilter) return null;

      const label = (type === "supply") ? "ë³´ê¸‰" : (type === "power" ? "ì†¡ì „ì†Œ" : type);
      const time = fmt(c.time);

      const rawParts = Array.isArray(c.participants) ? c.participants : [];
      const parts = applyHiddenFilterToParticipants(rawParts);
      const participants = parts.length ? parts.join(", ") : (rawParts.length ? "(ìˆ¨ê¹€ ì²˜ë¦¬ë¨)" : "-");

      const result = (type === "supply") ? (c.result || "-") : "-";

      // âœ… ì†Œí”„íŠ¸ ì‚­ì œ ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
      // âœ… ì´ë¯¸ ì‚­ì œëœ ê²½ìš°ì—ëŠ” ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
      const delCell = deleted
        ? `<span class="pill" style="opacity:.85;">ì‚­ì œë¨</span>`
        : `<button class="btn danger icon" data-softdel="${ds.id}">ì‚­ì œ</button>`;

      // âœ… ì‚­ì œ ë©”íƒ€ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
      const deletedMeta = deleted
        ? `<div style="margin-top:6px; color:rgba(255,255,255,0.65); font-size:12px; font-weight:800;">
             ì‚­ì œ: ${fmt(c.deletedAt)} / ${c.deletedBy || "-"}
           </div>`
        : ``;

      return `
        <tr>
          <td style="font-weight:900;">${label}${deleted ? ` <span class="pill" style="margin-left:6px;">DELETED</span>` : ""}</td>
          <td>${time}</td>
          <td class="left">${participants}${deletedMeta}</td>
          <td style="font-weight:900;">${result}</td>
          <td>${delCell}</td>
        </tr>
      `;
    }).filter(Boolean).join("");

    $("contentBody").innerHTML = rows || `<tr><td colspan="5" style="color:rgba(255,255,255,0.65);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

    // âœ… ì†Œí”„íŠ¸ ì‚­ì œ ë²„íŠ¼ì„ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
    $("contentBody").querySelectorAll("[data-softdel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

        const id = btn.getAttribute("data-softdel");
        if(!id) return;

        const ok = confirm("ì´ ì½˜í…ì¸  ê¸°ë¡ì„ ì‚­ì œ ì²˜ë¦¬(ì†Œí”„íŠ¸ ì‚­ì œ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if(!ok) return;

        try{
          // âœ… deleteDoc()ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì†Œí”„íŠ¸ ì‚­ì œ í”Œë˜ê·¸ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
          await updateDoc(doc(db, "contentRecords", id), {
            deleted: true,
            deletedAt: nowMs(),
            deletedBy: currentUser || "unknown"
          });

          // âœ… 1í˜ì´ì§€ëŠ” ì‹¤ì‹œê°„ì´ë¯€ë¡œ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
          // âœ… 2í˜ì´ì§€ ì´ìƒì€ ì•ˆì •í˜•ì´ë¯€ë¡œ ì¬ë¡œë”©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          if(contentPage !== 1){
            openContentPage(contentPage);
          }
        }catch(e){
          showAlert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
        }
      });
    });
  }

  // í˜ì´ì§€ ë²„íŠ¼ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderPager(active){
    const maxShow = 11;
    const start = Math.max(1, active - Math.floor(maxShow/2));
    const end = start + maxShow - 1;

    let html = `<span class="pagebtn" data-page="prev">â—€</span>`;
    for(let p=start; p<=end; p++){
      html += `<span class="pagebtn ${p===active?"active":""}" data-page="${p}">${p}</span>`;
    }
    html += `<span class="pagebtn" data-page="next">â–¶</span>`;
    $("pager").innerHTML = html;

    $("pager").querySelectorAll("[data-page]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-page");
        if(v === "prev"){
          if(contentPage > 1) openContentPage(contentPage - 1);
          return;
        }
        if(v === "next"){
          openContentPage(contentPage + 1);
          return;
        }
        const p = parseInt(v,10);
        if(Number.isFinite(p)) openContentPage(p);
      });
    });
  }

  // ì½˜í…ì¸  ê¸°ë³¸ ì¿¼ë¦¬ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
  function baseContentQuery(){
    return query(colContent, orderBy("time","desc"), limit(PAGE_SIZE));
  }

  // ì½˜í…ì¸  í˜ì´ì§€ë¥¼ ì—½ë‹ˆë‹¤.
  async function openContentPage(page){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    contentPage = page;

    if(page === 1){
      stopContentRealtime();
      const q = baseContentQuery();
      contentFirstUnsub = onSnapshot(q, (snap)=>{
        const docs = snap.docs;
        pageCursors[1] = docs.length ? docs[docs.length-1] : null;
        renderContentRows(docs);
        renderPager(1);
      });
      return;
    }

    stopContentRealtime();

    try{
      if(!pageCursors[1]){
        const first = await getDocs(baseContentQuery());
        if(first.docs.length){
          pageCursors[1] = first.docs[first.docs.length-1];
        }else{
          contentPage = 1;
          renderPager(1);
          renderContentRows([]);
          return;
        }
      }

      for(let p=2; p<=page; p++){
        if(pageCursors[p-1] == null){
          const prevCursor = pageCursors[p-2] || pageCursors[1];
          const prevQ = query(colContent, orderBy("time","desc"), startAfter(prevCursor), limit(PAGE_SIZE));
          const prevSnap = await getDocs(prevQ);
          if(prevSnap.docs.length){
            pageCursors[p-1] = prevSnap.docs[prevSnap.docs.length-1];
          }else{
            contentPage = p-1;
            break;
          }
        }
      }

      const prevLast = pageCursors[page-1];
      if(!prevLast){
        contentPage = Math.max(1, page-1);
        renderPager(contentPage);
        return;
      }

      const q = query(colContent, orderBy("time","desc"), startAfter(prevLast), limit(PAGE_SIZE));
      const snap = await getDocs(q);

      if(snap.docs.length === 0){
        contentPage = Math.max(1, page-1);
        renderPager(contentPage);
        return;
      }

      pageCursors[page] = snap.docs[snap.docs.length-1];
      renderContentRows(snap.docs);
      renderPager(contentPage);
    }catch(e){
      showAlert("í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      contentPage = 1;
      renderPager(1);
      renderContentRows([]);
    }
  }

  // ê´€ë¦¬ì ê¶Œí•œ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
  const adminRoleModal = $("adminRoleModal");
  function openAdminRoleModal(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    adminRoleSet = new Set();
    $("adminRoleSearch").value = "";
    $("adminRoleListWrap").style.display = "none";
    renderAdminRoleSelected();
    renderAdminRoleList();

    adminRoleModal.classList.add("show");
    adminRoleModal.setAttribute("aria-hidden","false");
  }

  // ê´€ë¦¬ì ê¶Œí•œ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
  function closeAdminRoleModal(){
    adminRoleModal.classList.remove("show");
    adminRoleModal.setAttribute("aria-hidden","true");
  }

  $("adminRoleBtn").addEventListener("click", openAdminRoleModal);
  $("adminRoleCloseTop").addEventListener("click", closeAdminRoleModal);
  adminRoleModal.addEventListener("click", (e)=>{ if(e.target===adminRoleModal) closeAdminRoleModal(); });

  $("adminRoleToggleListBtn").addEventListener("click", ()=>{
    const wrap = $("adminRoleListWrap");
    wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
  });
  $("adminRoleSearch").addEventListener("input", renderAdminRoleList);

  // ê´€ë¦¬ì ê¶Œí•œ ì„ íƒ ì¹©ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderAdminRoleSelected(){
    const el = $("adminRoleSelected");
    if(adminRoleSet.size === 0){
      el.innerHTML = `<span style="color:rgba(255,255,255,0.65); font-weight:900;">ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
      return;
    }
    el.innerHTML = Array.from(adminRoleSet).map(n => `
      <span class="selchip">
        ${n}
        <span class="xbtn" data-arx="${n}">Ã—</span>
      </span>
    `).join("");

    el.querySelectorAll("[data-arx]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        adminRoleSet.delete(btn.getAttribute("data-arx"));
        renderAdminRoleSelected();
      });
    });
  }

  // ê´€ë¦¬ì ê¶Œí•œ ì„ íƒ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
  function renderAdminRoleList(){
    const list = $("adminRoleList");
    const q = lowerNick($("adminRoleSearch").value);

    const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));
    const filtered = q ? users.filter(n => n.includes(q)) : users;

    list.innerHTML = filtered.length ? filtered.map(n=>{
      const u = usersCache.get(n) || {};
      const badges = [];
      if(u.isAdmin) badges.push("ê´€ë¦¬ì");
      if(u.hidden) badges.push("ìˆ¨ê¹€");
      const tag = badges.length ? badges.join(" Â· ") : "ìœ ì €";
      return `
        <div class="userrow" data-arn="${n}">
          <div class="name">${n}</div>
          <div class="tag">${tag}</div>
        </div>
      `;
    }).join("") : `<div style="color:rgba(255,255,255,0.7); font-weight:900;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

    list.querySelectorAll("[data-arn]").forEach(row=>{
      row.addEventListener("click", ()=>{
        const n = row.getAttribute("data-arn");
        if(!n) return;
        adminRoleSet.add(n);
        renderAdminRoleSelected();
      });
    });
  }

  // ê´€ë¦¬ì ê¶Œí•œì„ ì¼ê´„ ì ìš©í•©ë‹ˆë‹¤.
  async function applyAdminRole(isAdminValue){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const targets = Array.from(adminRoleSet);
    if(targets.length === 0) return showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");

    const ok = confirm(isAdminValue ? "ì„ íƒ ìœ ì €ë¥¼ ê´€ë¦¬ì ì„ëª…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì„ íƒ ìœ ì €ë¥¼ ê´€ë¦¬ì í•´ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if(!ok) return;

    try{
      await Promise.all(targets.map(n => updateDoc(doc(db,"users",n), { isAdmin: isAdminValue })));
      adminRoleSet = new Set();
      renderAdminRoleSelected();
      renderAdminRoleList();
      setTinyStatus("statsMsg", "ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      showAlert("ê´€ë¦¬ì ê¶Œí•œ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  $("adminRoleGrantBtn").addEventListener("click", ()=> applyAdminRole(true));
  $("adminRoleRevokeBtn").addEventListener("click", ()=> applyAdminRole(false));

  // ì´ˆê¸° ë¡œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
  (async ()=>{
    try{ await refreshUsersCacheOnce(); }catch{}
  })();
</script>
</body>
</html>